#!/usr/bin/env node

import { writeFile, mkdir } from 'fs/promises'
import { existsSync } from 'fs'
import { join, dirname } from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

const MAPS = [
  {
    url: 'https://servicodados.ibge.gov.br/api/v4/malhas/paises/BR?formato=application/vnd.geo+json&qualidade=minima',
    filename: join(__dirname, '..', 'src', 'assets', 'brazil.json'),
  },
  {
    url: 'https://servicodados.ibge.gov.br/api/v4/malhas/paises/BR?intrarregiao=regiao&formato=application/vnd.geo+json&qualidade=minima',
    filename: join(__dirname, '..', 'public', 'maps', 'brazil-regions.json'),
  },
  {
    url: 'https://servicodados.ibge.gov.br/api/v4/malhas/paises/BR?intrarregiao=municipio&formato=application/vnd.geo+json&qualidade=minima',
    filename: join(
      __dirname,
      '..',
      'public',
      'maps',
      'brazil-municipalities.json',
    ),
  },
  {
    url: 'https://servicodados.ibge.gov.br/api/v4/malhas/paises/BR?intrarregiao=uf&formato=application/vnd.geo+json&qualidade=minima',
    filename: join(__dirname, '..', 'public', 'maps', 'brazil-states.json'),
  },
]

for (const map of MAPS) {
  await fetchMap(map.url, map.filename)
}

console.log('✓ All maps fetched successfully!')

async function fetchMap(url, filename) {
  try {
    const geojson = await fetchJSON(url)
    console.log(`✓ Fetched GeoJSON for ${filename}`)

    // Use 'd3' winding order for D3.js compatibility
    const geojsonFixed = fixIBGEWinding(geojson)
    console.log(`✓ Fixed winding order for ${filename}`)

    // Ensure properties only contain the code
    for (const feature of geojsonFixed.features) {
      feature.properties = {
        code: Number(feature.properties.codarea),
      }
    }

    const dir = dirname(filename)

    if (!existsSync(dir)) {
      await mkdir(dir, { recursive: true })
    }

    await writeFile(filename, JSON.stringify(geojsonFixed, null, 2))
    console.log(`✓ Saved to ${filename}\n`)
  } catch (err) {
    console.error(`✗ Error processing ${filename}: ${err.message}\n`)
    throw err
  }
}

// Fix the IBGE GeoJSON winding order
function fixIBGEWinding(geojson) {
  const fixed = structuredClone(geojson)

  fixed.features.forEach((feature) => {
    if (feature.geometry.type === 'MultiPolygon') {
      feature.geometry.coordinates = feature.geometry.coordinates.map(
        (polygon) => polygon.map((ring) => ring.reverse()),
      )
    } else if (feature.geometry.type === 'Polygon') {
      feature.geometry.coordinates = feature.geometry.coordinates.map((ring) =>
        ring.reverse(),
      )
    }
  })

  return fixed
}

async function fetchJSON(url) {
  console.log(`Fetching: ${url}`)
  const response = await fetch(url)

  if (!response.ok) {
    throw new Error(`HTTP ${response.status}: ${response.statusText}`)
  }

  return response.json()
}
